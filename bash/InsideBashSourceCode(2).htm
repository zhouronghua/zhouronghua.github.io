<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=gb2312">
<meta name=Generator content="Microsoft Word 12 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:宋体;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Cambria;
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:华文仿宋;
	panose-1:2 1 6 0 4 1 1 1 1 1;}
@font-face
	{font-family:仿宋_GB2312;}
@font-face
	{font-family:"\@宋体";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"\@华文仿宋";
	panose-1:2 1 6 0 4 1 1 1 1 1;}
@font-face
	{font-family:"\@仿宋_GB2312";}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:"Times New Roman","serif";}
h1
	{mso-style-link:"标题 1 Char";
	margin-top:17.0pt;
	margin-right:0cm;
	margin-bottom:16.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:240%;
	page-break-after:avoid;
	font-size:22.0pt;
	font-family:"Times New Roman","serif";
	font-weight:bold;}
h2
	{mso-style-link:"标题 2 Char";
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:173%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Cambria","serif";
	font-weight:bold;}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	layout-grid-mode:char;
	border:none;
	padding:0cm;
	font-size:9.0pt;
	font-family:"Times New Roman","serif";}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{margin:0cm;
	margin-bottom:.0001pt;
	layout-grid-mode:char;
	font-size:9.0pt;
	font-family:"Times New Roman","serif";}
p.MsoTitle, li.MsoTitle, div.MsoTitle
	{mso-style-link:"标题 Char";
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.0pt;
	margin-left:0cm;
	text-align:center;
	font-size:16.0pt;
	font-family:"Cambria","serif";
	font-weight:bold;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;}
p.MsoDocumentMap, li.MsoDocumentMap, div.MsoDocumentMap
	{mso-style-link:"文档结构图 Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:9.0pt;
	font-family:宋体;}
p
	{margin-right:0cm;
	margin-left:0cm;
	font-size:12.0pt;
	font-family:宋体;}
p.MsoAcetate, li.MsoAcetate, div.MsoAcetate
	{mso-style-link:"批注框文本 Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:9.0pt;
	font-family:"Times New Roman","serif";}
span.Char
	{mso-style-name:"批注框文本 Char";
	mso-style-link:批注框文本;}
span.Char0
	{mso-style-name:"标题 Char";
	mso-style-link:标题;
	font-family:"Cambria","serif";
	font-weight:bold;}
span.Char1
	{mso-style-name:"文档结构图 Char";
	mso-style-link:文档结构图;
	font-family:宋体;}
span.1Char
	{mso-style-name:"标题 1 Char";
	mso-style-link:"标题 1";
	font-weight:bold;}
span.2Char
	{mso-style-name:"标题 2 Char";
	mso-style-link:"标题 2";
	font-family:"Cambria","serif";
	font-weight:bold;}
.MsoChpDefault
	{font-size:10.0pt;}
 /* Page Definitions */
 @page WordSection1
	{size:595.3pt 841.9pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	layout-grid:15.6pt;}
div.WordSection1
	{page:WordSection1;}
-->
</style>

</head>

<body lang=ZH-CN link=blue vlink=purple style='text-justify-trim:punctuation'>

<div class=WordSection1 style='layout-grid:15.6pt'>

<p class=MsoTitle><span style='position:absolute;z-index:-1;left:0px;
margin-left:3px;margin-top:205px;width:521px;height:519px'><img width=521
height=519 src="InsideBashSourceCode(2).files/image001.png"
alt="ZTE Confidential"></span><span lang=EN-US style='font-size:14.0pt'>Bash</span><span
style='font-size:14.0pt;font-family:宋体'>源码分析</span><span lang=EN-US
style='font-size:14.0pt'>(2)</span></p>

<p class=MsoNormal align=right style='text-align:right'><span style='font-family:
宋体'>周荣华</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:宋体'>作者简介：</span><span lang=EN-US>10</span><span
style='font-family:宋体'>年通讯底层研发经验，熟悉</span><span lang=EN-US>linux/vxworks</span><span
style='font-family:宋体'>等实时操作系统的内核原理和实现，在虚拟化的</span><span lang=EN-US>openstack</span><span
style='font-family:宋体'>，</span><span lang=EN-US>kubernetes</span><span
style='font-family:宋体'>，</span><span lang=EN-US>docker</span><span
style='font-family:宋体'>等领域也初有涉猎。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:宋体'>摘要：前文主要讲述了通用数据结构和</span><span
lang=EN-US>for</span><span style='font-family:宋体'>、</span><span lang=EN-US>case</span><span
style='font-family:宋体'>语句的定义，本文继续讲解</span><span lang=EN-US>WHILE</span><span
style='font-family:宋体'>、</span><span lang=EN-US>IF</span><span
style='font-family:宋体'>、</span><span lang=EN-US>CONNECTION</span><span
style='font-family:宋体'>和</span><span lang=EN-US>SIMPLE_COM</span><span
style='font-family:宋体'>的讲解。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US style='font-size:14.0pt;line-height:240%'>3 bash</span><span
style='font-size:14.0pt;line-height:240%;font-family:宋体'>使用到的主要数据结构介绍</span></h1>

<h2><span lang=EN-US style='font-size:14.0pt;line-height:173%'>3.4 WHILE_COM</span></h2>

<p class=MsoNormal><span lang=EN-US><img width=554 height=106
src="InsideBashSourceCode(2).files/image002.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>WHILE_COM</span><span style='font-family:
宋体'>比较简单，主体有两部分组成，判断条件和执行体。上篇文章调试过程中导致</span><span lang=EN-US>CPU</span><span
style='font-family:宋体'>冲高到</span><span lang=EN-US>100%</span><span
style='font-family:宋体'>的例子就是用的</span><span lang=EN-US>WHILE_COM</span><span
style='font-family:宋体'>，不过例子中的</span><span lang=EN-US>WHILE_COM</span><span
style='font-family:宋体'>的判断条件留空，相当于永远为</span><span lang=EN-US>true</span><span
style='font-family:宋体'>。</span></p>

<p class=MsoNormal><span lang=EN-US><img width=241 height=26
src="InsideBashSourceCode(2).files/image003.png"></span></p>

<h2><span lang=EN-US style='font-size:14.0pt;line-height:173%'>3.5 IF_COM</span></h2>

<p class=MsoNormal><span lang=EN-US><img width=554 height=99
src="InsideBashSourceCode(2).files/image004.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>IF_COM</span><span style='font-family:宋体'>由</span><span
lang=EN-US>3</span><span style='font-family:宋体'>段组成，条件判断，条件为</span><span
lang=EN-US>true</span><span style='font-family:宋体'>时的执行体和条件为</span><span
lang=EN-US>false</span><span style='font-family:宋体'>时的执行体，其中</span><span
lang=EN-US>false</span><span style='font-family:宋体'>情况下的执行体可以为空。</span></p>

<p class=MsoNormal><span lang=EN-US><img width=226 height=91
src="InsideBashSourceCode(2).files/image005.png"></span></p>

<p class=MsoNormal><span style='font-family:宋体'>从</span><span lang=EN-US>IF_COM</span><span
style='font-family:宋体'>的定义看，</span><span lang=EN-US>3</span><span
style='font-family:宋体'>部分都可以是复杂的</span><span lang=EN-US>COMMAND</span><span
style='font-family:宋体'>结构，所以嵌套起来也可以做的非常复杂，例如可以在</span><span lang=EN-US>test</span><span
style='font-family:宋体'>部分通过执行脚本，依靠脚本的返回值来判断是应该执行</span><span lang=EN-US>true_case</span><span
style='font-family:宋体'>还是</span><span lang=EN-US>false_case</span><span
style='font-family:宋体'>。</span></p>

<h2><span lang=EN-US style='font-size:14.0pt;line-height:173%'>3.6 CONNECTION</span></h2>

<p class=MsoNormal><span lang=EN-US><img width=554 height=106 id="图片 1"
src="InsideBashSourceCode(2).files/image006.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>CONNECTION</span><span style='font-family:
宋体'>由</span><span lang=EN-US>4</span><span style='font-family:宋体'>个属性组成：</span><span
lang=EN-US>ignore</span><span style='font-family:宋体'>字段对应其他命令结构种的</span><span
lang=EN-US>flags</span><span style='font-family:宋体'>，但对连接命令实际上没有用</span><span
lang=EN-US>first</span><span style='font-family:宋体'>对应第一条命令，</span><span
lang=EN-US>second</span><span style='font-family:宋体'>对应第二条命令，</span><span
lang=EN-US>connector</span><span style='font-family:宋体'>对应两条命令之间的连接符。难道只能两个命令一起用，不能多余两个命令一起调用？显然不是，一个</span><span
lang=EN-US>CONNECTION</span><span style='font-family:宋体'>对应一个连接符连接起来的两段命令，每段命令又可以是一个</span><span
lang=EN-US>CONNECTION</span><span style='font-family:宋体'>，这样就形成了级联的效果。</span></p>

<p class=MsoNormal><span lang=EN-US>CONNECTION</span><span style='font-family:
宋体'>有</span><span lang=EN-US>3</span><span style='font-family:宋体'>种：</span><span
lang=EN-US>AND_AND</span><span style='font-family:宋体'>对应“</span><span
lang=EN-US>&amp;&amp;</span><span style='font-family:宋体'>”，表示</span><span
lang=EN-US>first</span><span style='font-family:宋体'>执行返回结果为</span><span
lang=EN-US>0</span><span style='font-family:宋体'>的时候执行</span><span lang=EN-US>second</span><span
style='font-family:宋体'>；</span><span lang=EN-US>OR_OR</span><span
style='font-family:宋体'>对应“</span><span lang=EN-US>||</span><span
style='font-family:宋体'>”，表示</span><span lang=EN-US>first</span><span
style='font-family:宋体'>执行返回结果为非</span><span lang=EN-US>0</span><span
style='font-family:宋体'>的时候执行</span><span lang=EN-US>second</span><span
style='font-family:宋体'>；分号对应的</span><span lang=EN-US>connector</span><span
style='font-family:宋体'>还是分号，表示无论</span><span lang=EN-US>first</span><span
style='font-family:宋体'>执行结果是</span><span lang=EN-US>0</span><span
style='font-family:宋体'>还是非</span><span lang=EN-US>0</span><span
style='font-family:宋体'>，都执行</span><span lang=EN-US>second</span><span
style='font-family:宋体'>。是不是有点像</span><span lang=EN-US>C</span><span
style='font-family:宋体'>语言里面的</span><span lang=EN-US>&amp;&amp;</span><span
style='font-family:宋体'>，</span><span lang=EN-US>||</span><span
style='font-family:宋体'>和</span><span lang=EN-US>;</span><span style='font-family:
宋体'>？</span></p>

<p class=MsoNormal><span lang=EN-US><img width=230 height=66 id="图片 4"
src="InsideBashSourceCode(2).files/image007.png"></span></p>

<p class=MsoNormal><span style='font-family:宋体'>上面的三个例子别真的执行，后果很严重</span><span
lang=EN-US>(</span><span lang=EN-US style='font-family:Wingdings'>J</span><span
lang=EN-US>)</span><span style='font-family:宋体'>。第一条表示删除</span><span
lang=EN-US>$dir</span><span style='font-family:宋体'>对应值的目录中的所有文件；第二条表示</span><span
lang=EN-US>$dir</span><span style='font-family:宋体'>不存在的时候删除当前目录下面的所有文件；第三条表示，如果</span><span
lang=EN-US>$dir</span><span style='font-family:宋体'>存在就删除</span><span
lang=EN-US>$dir</span><span style='font-family:宋体'>目录下的所有文件，如果不存在就删除当前目录下面的所有文件。</span></p>

<h2><span lang=EN-US style='font-size:14.0pt;line-height:173%'>3.7 SIMPLE_COM</span></h2>

<p class=MsoNormal><span lang=EN-US><img width=554 height=117 id="图片 7"
src="InsideBashSourceCode(2).files/image008.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>SIMPLE_COM</span><span style='font-family:
宋体'>按字面意思就是简单命令，结构体由四部分组成，通用的</span><span lang=EN-US>flags</span><span
style='font-family:宋体'>，行号</span><span lang=EN-US>line</span><span
style='font-family:宋体'>，命令队列</span><span lang=EN-US>WORD_LIST</span><span
style='font-family:宋体'>，重定向队列</span><span lang=EN-US>REDIRECT</span><span
style='font-family:宋体'>。</span> </p>

<p class=MsoNormal><span lang=EN-US>WORD_LIST</span><span style='font-family:
宋体'>队列比较容易理解。一堆命令的集合：</span></p>

<p class=MsoNormal><span lang=EN-US><img width=311 height=81 id="图片 10"
src="InsideBashSourceCode(2).files/image009.png"></span></p>

<p class=MsoNormal><span style='font-family:宋体'>其中单个命令还可以独立设置</span><span
lang=EN-US>flags</span><span style='font-family:宋体'>：</span></p>

<p class=MsoNormal><span lang=EN-US><img width=538 height=86 id="图片 13"
src="InsideBashSourceCode(2).files/image010.png"></span></p>

<p class=MsoNormal><span lang=EN-US>REDIRECT</span><span style='font-family:
宋体'>就是重定向的意思，这里也有很多种重定向，结构体的各个属性的含义：</span><span lang=EN-US>next</span><span
style='font-family:宋体'>，组成重定向链表的指针；</span><span lang=EN-US>redirector</span><span
style='font-family:宋体'>，重定向的源；</span><span lang=EN-US>rflags</span><span
style='font-family:宋体'>，重定向时使用的私有</span><span lang=EN-US>flags</span><span
style='font-family:宋体'>；</span><span lang=EN-US>flags</span><span
style='font-family:宋体'>，打开重定向目标文件时的</span><span lang=EN-US>flags</span><span
style='font-family:宋体'>；</span><span lang=EN-US>instruction</span><span
style='font-family:宋体'>，重定向的实际功能指令，这个又有很多种，下面会详细描述；</span><span lang=EN-US>redirectee</span><span
style='font-family:宋体'>，重定向的目的文件描述符或者文件名；</span><span lang=EN-US>here_doc_eof</span><span
style='font-family:宋体'>，本地文件。</span></p>

<p class=MsoNormal><span lang=EN-US><img width=554 height=143 id="图片 19"
src="InsideBashSourceCode(2).files/image011.jpg"></span></p>

<p class=MsoNormal><span style='font-family:宋体'>从</span><span lang=EN-US>REDIRECTEE</span><span
style='font-family:宋体'>的定义看，它既可以是一个文件描述符，例如</span><span lang=EN-US>0</span><span
style='font-family:宋体'>表示标准输入，</span><span lang=EN-US>1</span><span
style='font-family:宋体'>表示标准输出，</span><span lang=EN-US>2</span><span
style='font-family:宋体'>表示错误输出，也可以是一个文件名。</span></p>

<p class=MsoNormal><span lang=EN-US><img width=554 height=66 id="图片 22"
src="InsideBashSourceCode(2).files/image012.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>Bash</span><span style='font-family:宋体'>支持二十种不同的重定向，后面会根据</span><span
lang=EN-US>bash</span><span style='font-family:宋体'>的源代码来一一解释一下具体内容（</span><span
lang=EN-US>bash</span><span style='font-family:宋体'>源代码的注释对重定向的含义理解也有很多帮助）：</span></p>

<p class=MsoNormal><span lang=EN-US><img width=554 height=139 id="图片 25"
src="InsideBashSourceCode(2).files/image013.jpg"></span></p>

<p class=MsoNormal><span style='font-family:宋体'>先来五种输出的重定向：普通输出，强制输出，错误和标准输出，叠加输出，错误和标准叠加输出。统一说一下几个概念，标准输出就是</span><span
lang=EN-US>2</span><span style='font-family:宋体'>级</span><span lang=EN-US>stdout</span><span
style='font-family:宋体'>，错误输出就是</span><span lang=EN-US>3</span><span
style='font-family:宋体'>级</span><span lang=EN-US>sdterr</span><span
style='font-family:宋体'>，强制的意思是文件存在的情况下会被先清空，再增加，叠加输出的意思是原有内容后面再增加。</span></p>

<p class=MsoNormal><span lang=EN-US><img width=526 height=180 id="图片 28"
src="InsideBashSourceCode(2).files/image014.png"></span></p>

<p class=MsoNormal><span style='font-family:宋体'>再来九种输入和输出重定向：普通输入重定向，后台执行，输入和输出同时重定向，去掉空格的输入重定向，输入重定向，字符串作为输入，关闭重定向源（怎么还有这种应用场景？），复制输入，复制输出。</span></p>

<p class=MsoNormal><span lang=EN-US><img width=554 height=262 id="图片 31"
src="InsideBashSourceCode(2).files/image015.png"></span></p>

<p class=MsoNormal><span style='font-family:宋体'>紧接着六种输入输出的重定向分别为输入剪切，输出剪切，字符指向的输入剪切和字符指向的输出剪切，字符指向的输入复制和字符指向的输出复制。</span></p>

<p class=MsoNormal><span lang=EN-US><img width=554 height=167 id="图片 37"
src="InsideBashSourceCode(2).files/image016.png"></span></p>

<p class=MsoNormal><span lang=EN-US>Bash</span><span style='font-family:宋体'>的重定向真是博大精深！！明天继续其他</span><span
lang=EN-US>COMMAND</span><span style='font-family:宋体'>的定义讲解。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

</div>

</body>

</html>
